---
title: "Total Score"
author: "Grace Bianchi"
date: '2022-11-14'
output: html_document
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(tidyverse)
library(janitor)
library(googlesheets4)

```

```{r}
# read in the data
real_estate_score_data <- read_sheet("https://docs.google.com/spreadsheets/d/1Ssmb7pUd4NFZocVp9C75SRMOV6tAJCCt0TjrCYBB8pY/edit#gid=1038418521") %>% 
  select(cbsa, real_estate_score)

rental_policy_score_data <- read_sheet("https://docs.google.com/spreadsheets/d/1nLpDhM88a3rEBDVK5RZlk2B6QuwVIwvsfE5HeBz0mLo/edit#gid=983090810") %>% 
  select(cbsa, landlord_score)

reopt_data <- read_sheet("https://docs.google.com/spreadsheets/d/1tPqpmS8JOeRyunEmSyFYPYwshKDGx54Z-MISgYO3wZE/edit#gid=1874679054") %>% 
  select(cbsa, city_msa, state, normalized_irr, inverted_n_total_co2, inverted_n_health_emissions_cost, normalized_annual_renewable)

climate_risk_data <- read_sheet("https://docs.google.com/spreadsheets/d/1HZCeNGf61RJ9GJs3cLJcl9aNpvmPMBF1Yoss2fytltc/edit#gid=2045475301", sheet = "climate_risk+EAL") %>% 
  select(cbsa, normalized_inverted_climate_risk, inverted_n_eal_score)

```


```{r read in data}
criteria_all <- real_estate_score_data %>% 
  inner_join(rental_policy_score_data)  %>% 
  inner_join(reopt_data) %>% 
  inner_join(climate_risk_data) # combine all criteria scores into one dataframe

# reorder columns
col_order <-c("cbsa", "city_msa", "state", "real_estate_score", "landlord_score", "normalized_annual_renewable", "normalized_irr", "inverted_n_total_co2", "normalized_inverted_climate_risk", "inverted_n_eal_score", "inverted_n_health_emissions_cost")

criteria_all <- criteria_all[, col_order] %>% 
  select(!inverted_n_eal_score)

```

```{r}
# weighting criteria
weighted_criteria <- criteria_all %>% 
  select(4:10) 

weighted <- t(t(weighted_criteria)*criteria_weights_client)
```

```{r FINAL student weights}
# weight criteria for students
criteria_weights_students <- c(0.18, 0.0, 0.10, 0.19, 0.17, 0.14, 0.22)

#make landlord_score column
criteria_all <- criteria_all %>% 
  mutate(final_tot_students = cbsa,
         real_estate_score = as.numeric(real_estate_score),
         landlord_score = as.numeric(landlord_score)) #this is just a place holder
  

size <- dim(criteria_all)
for (i in 1:size[1]) {
  cbsa_data <- c(criteria_all$real_estate_score[i],
                criteria_all$landlord_score[i],
                 criteria_all$normalized_irr[i],
                 criteria_all$inverted_n_total_co2[i],
                criteria_all$inverted_n_health_emissions_cost[i],
                criteria_all$normalized_annual_renewable[i],
                criteria_all$normalized_inverted_climate_risk[i]
                  )
  criteria_all$final_tot_students[i] = weighted.mean(cbsa_data, criteria_weights_students)
}

```



```{r Client FINAL WEIGHTS}

client_weights <- c(0.18, 0.07, 0.11, 0.07, 0.0, 0.07, 0.50)
  
#make landlord_score column
criteria_all <- criteria_all %>% 
  mutate(client_FINAL_score = cbsa, #this is just a place holder
         score_climate50_prop_EAL = cbsa)

size <- dim(criteria_all)
for (i in 1:size[1]) {
  cbsa_data <- c(criteria_all$real_estate_score[i],
                criteria_all$landlord_score[i],
                 criteria_all$normalized_irr[i],
                 criteria_all$inverted_n_total_co2[i],
                criteria_all$inverted_n_health_emissions_cost[i],
                criteria_all$normalized_annual_renewable[i],
                criteria_all$normalized_inverted_climate_risk[i]
                  )
  criteria_all$client_FINAL_score[i] = weighted.mean(cbsa_data, client_weights) 
}

```


```{r rename columns and output to google sheet}

criteria_all <- criteria_all %>% 
  rename(financial_score = normalized_irr,
         co2_e = inverted_n_total_co2,
         health_impact = inverted_n_health_emissions_cost,
         electricity = normalized_annual_renewable,
         climate_risk = normalized_inverted_climate_risk) %>% 
  mutate_if(is.numeric, ~round(., 5))


#sheet_write(criteria_all, ss = "https://docs.google.com/spreadsheets/d/1yqjhJvXUcEiC3qiYWkKNlF6NNpYXWg15zZHwmwpS5Q0/edit#gid=0", sheet = "FINAL_total_score")
```

### Data Visualization- barcharts

```{r client data viz}
## read in weighted criteria sheet
client_weighted_criteria <- read_sheet(ss = "https://docs.google.com/spreadsheets/d/1yqjhJvXUcEiC3qiYWkKNlF6NNpYXWg15zZHwmwpS5Q0/edit#gid=0", sheet = "wtd_criteria_Owen") %>% 
  unite("msa_state", city_msa:state, sep = ", ")


# read in cbsa data with full names
score_tidy <- client_weighted_criteria %>% 
  pivot_longer(cols = c("WT_real_estate":"WT_climRisk"), # selecting criteria cols
               names_to = "criteria",
               values_to = "criteria_score") %>% 
 filter(msa_state != "Portland, ME") %>%  # removing portland (negative number)
  group_by(cbsa) 


tiff(filename = "wt_criteria_client_chart.tiff",width = 8, height = 6, units = "in", res = 300, pointsize = 12)
ggplot(data = score_tidy, aes(y = reorder(msa_state, FINAL_owen_SCORE), x = criteria_score)) +
    geom_col(aes(fill = criteria)) +
  labs(x = "Total Score",
       y = " ",
       title = "Client") +
  theme_bw() +
  guides(fill=guide_legend(title="Criteria (weighted)")) +
   scale_fill_manual(values = c("palevioletred1","orange",  "gold", "#44AA99", "dodgerblue4", "#BC80BD"),
                     labels=c('Climate Risk', 'CO2 Emissions', 'Electricity', "Solar IRR", "Real Estate", "Landlord Policy")) +
  scale_x_continuous(limits = c(0, 0.7), expand = c(0,0), breaks=seq(0, 0.7, 0.1))
dev.off()
```

```{r student data viz}
## read in weighted criteria sheet
student_weighted_criteria <- read_sheet(ss = "https://docs.google.com/spreadsheets/d/1yqjhJvXUcEiC3qiYWkKNlF6NNpYXWg15zZHwmwpS5Q0/edit#gid=0", sheet = "wtd_criteria_stud") %>% 
  unite("msa_state", city_msa:state, sep = ", ")


# read in cbsa data with full names
score_tidy2 <- student_weighted_criteria %>% 
  pivot_longer(cols = c("WT_real_estate":"WT_climRisk"), # selecting criteria cols
               names_to = "criteria",
               values_to = "criteria_score") %>% 
# filter(msa_state != "Portland, ME") %>%  # removing portland (negative number)
  group_by(cbsa) 


tiff(filename = "wt_criteria_student_chart.tiff", width = 8, height = 6, units = "in", res = 300)
ggplot(data = score_tidy2, aes(y = reorder(msa_state, FINAL_st_score), x = criteria_score)) + 
    geom_col(aes(fill = criteria)) +
  labs(x = "Total Score",
       y = " ",
       title = "Student") +
  theme_bw() +
  guides(fill=guide_legend(title="Criteria (weighted)")) +
   scale_fill_manual(values = c("palevioletred1", "orange",  "gold", "#44AA99", "dodgerblue4", "#6495ED"),
                     labels=c('Climate Risk', 'CO2 Emissions', 'Electricity', "Solar IRR", "Real Estate", "Health Impacts")) +
  scale_x_continuous(limits = c(0, 0.8), expand = c(0,0), breaks=seq(0, 0.8, 0.1))
dev.off()
```
