---
title: "Total Score"
author: "Grace Bianchi"
date: '2022-11-14'
output: html_document
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(tidyverse)
library(janitor)
library(googlesheets4)

```

```{r}
# read in the data
real_estate_score_data <- read_sheet("https://docs.google.com/spreadsheets/d/1Ssmb7pUd4NFZocVp9C75SRMOV6tAJCCt0TjrCYBB8pY/edit#gid=1038418521") %>% 
  select(cbsa, real_estate_score)

rental_policy_score_data <- read_sheet("https://docs.google.com/spreadsheets/d/1nLpDhM88a3rEBDVK5RZlk2B6QuwVIwvsfE5HeBz0mLo/edit#gid=983090810") %>% 
  select(cbsa, landlord_score)

reopt_data <- read_sheet("https://docs.google.com/spreadsheets/d/1tPqpmS8JOeRyunEmSyFYPYwshKDGx54Z-MISgYO3wZE/edit#gid=1874679054") %>% 
  select(cbsa, city_msa, state, normalized_irr, inverted_n_total_co2, inverted_n_health_emissions_cost, normalized_annual_renewable)

climate_risk_data <- read_sheet("https://docs.google.com/spreadsheets/d/1HZCeNGf61RJ9GJs3cLJcl9aNpvmPMBF1Yoss2fytltc/edit#gid=2045475301", sheet = "climate_risk+EAL") %>% 
  select(cbsa, normalized_inverted_climate_risk, inverted_n_eal_score)

```


```{r read in data}
criteria_all <- real_estate_score_data %>% 
  inner_join(rental_policy_score_data)  %>% 
  inner_join(reopt_data) %>% 
  inner_join(climate_risk_data) # combine all criteria scores into one dataframe

# reorder columns
col_order <-c("cbsa", "city_msa", "state", "real_estate_score", "landlord_score", "normalized_annual_renewable", "normalized_irr", "inverted_n_total_co2", "normalized_inverted_climate_risk", "inverted_n_eal_score", "inverted_n_health_emissions_cost")

criteria_all <- criteria_all[, col_order]


```


```{r original weights}
# weight criteria for Owen
criteria_weights_owen <- c(0.37, 0.12, 0.22, 0.07, 0.0, 0.07, 0.15)

#make landlord_score column
criteria_all <- criteria_all %>% 
  mutate(total_score_owen = cbsa, #this is just a place holder
         real_estate_score = as.numeric(real_estate_score),
         landlord_score = as.numeric(landlord_score)
  )

size <- dim(criteria_all)
for (i in 1:size[1]) {
  cbsa_data <- c(criteria_all$real_estate_score[i],
                criteria_all$landlord_score[i],
                 criteria_all$normalized_irr[i],
                 criteria_all$inverted_n_total_co2[i],
                criteria_all$inverted_n_health_emissions_cost[i],
                criteria_all$normalized_annual_renewable[i],
                criteria_all$normalized_inverted_climate_risk[i])
  criteria_all$total_score_owen[i] = weighted.mean(cbsa_data, criteria_weights_owen)
}

```


```{r student weights}
# weight criteria for students
criteria_weights_students <- c(0.18, 0.0, 0.10, 0.19, 0.17, 0.14, 0.22)

#make landlord_score column
criteria_all <- criteria_all %>% 
  mutate(total_score_students = cbsa,
         stud_EAL_total = cbsa) #this is just a place holder
  

size <- dim(criteria_all)
for (i in 1:size[1]) {
  cbsa_data <- c(criteria_all$real_estate_score[i],
                criteria_all$landlord_score[i],
                 criteria_all$normalized_irr[i],
                 criteria_all$inverted_n_total_co2[i],
                criteria_all$inverted_n_health_emissions_cost[i],
                criteria_all$normalized_annual_renewable[i],
                criteria_all$normalized_inverted_climate_risk[i]
                  )
  criteria_all$total_score_students[i] = weighted.mean(cbsa_data, criteria_weights_students)
}


size <- dim(criteria_all)
for (i in 1:size[1]) {
  cbsa_data <- c(criteria_all$real_estate_score[i],
                criteria_all$landlord_score[i],
                 criteria_all$normalized_irr[i],
                 criteria_all$inverted_n_total_co2[i],
                criteria_all$inverted_n_health_emissions_cost[i],
                criteria_all$normalized_annual_renewable[i],
                criteria_all$inverted_n_eal_score[i]
                  )
  criteria_all$stud_EAL_total[i] = weighted.mean(cbsa_data, criteria_weights_students)
}

```


```{r OWEN FINAL WEIGHTS climate risk 50 and proportional weights for others}

weights_climate50_prop <- c(0.18, 0.07, 0.11, 0.07, 0.0, 0.07, 0.50)

  
#make landlord_score column
criteria_all <- criteria_all %>% 
  mutate(score_climate50_prop = cbsa, #this is just a place holder
         score_climate50_prop_EAL = cbsa)


size <- dim(criteria_all)
for (i in 1:size[1]) {
  cbsa_data <- c(criteria_all$real_estate_score[i],
                criteria_all$landlord_score[i],
                 criteria_all$normalized_irr[i],
                 criteria_all$inverted_n_total_co2[i],
                criteria_all$inverted_n_health_emissions_cost[i],
                criteria_all$normalized_annual_renewable[i],
                criteria_all$normalized_inverted_climate_risk[i]
                  )
  criteria_all$score_climate50_prop[i] = weighted.mean(cbsa_data, weights_climate50_prop) 
}

### Using climate weight 50 and proportional others with EAL
for (i in 1:size[1]) {
  cbsa_data <- c(criteria_all$real_estate_score[i],
                criteria_all$landlord_score[i],
                 criteria_all$normalized_irr[i],
                 criteria_all$inverted_n_total_co2[i],
                criteria_all$inverted_n_health_emissions_cost[i],
                criteria_all$normalized_annual_renewable[i],
                criteria_all$inverted_n_eal_score[i]
                  )
  criteria_all$score_climate50_prop_EAL[i] = weighted.mean(cbsa_data, weights_climate50_prop) 
}


```

```{r climate risk 35 and Jan 31 weights from owen, eval = FALSE}

weights_climate35_owen <- c(0.25, 0.1, 0.15, 0.075, 0.0, 0.075, 0.35)

  
#make landlord_score column
criteria_all <- criteria_all %>% 
  mutate(score_climate35_owen = cbsa)#this is just a place holder


size <- dim(criteria_all)
for (i in 1:size[1]) {
  cbsa_data <- c(criteria_all$real_estate_score[i],
                criteria_all$landlord_score[i],
                 criteria_all$normalized_irr[i],
                 criteria_all$inverted_n_total_co2[i],
                criteria_all$inverted_n_health_emissions_cost[i],
                criteria_all$normalized_annual_renewable[i],
                criteria_all$normalized_inverted_climate_risk[i]
                  )
  criteria_all$score_climate35_owen[i] = weighted.mean(cbsa_data, weights_climate35_owen) 
}
```

```{r rename columns and output to google sheet}

criteria_all <- criteria_all %>% 
  rename(financial_score = normalized_irr,
         co2_e = inverted_n_total_co2,
         health_impact = inverted_n_health_emissions_cost,
         electricity = normalized_annual_renewable,
         climate_risk = normalized_inverted_climate_risk,
         climate_EAL_risk = inverted_n_eal_score) %>% 
  mutate_if(is.numeric, ~round(., 5))


sheet_write(criteria_all, ss = "https://docs.google.com/spreadsheets/d/1yqjhJvXUcEiC3qiYWkKNlF6NNpYXWg15zZHwmwpS5Q0/edit#gid=0", sheet = "FINAL_total_score")
```


```{r data viz, eval = FALSE}

score_tidy <- criteria_all %>% 
  pivot_longer(cols = c(4:18),
               names_to = "criteria",
               values_to = "criteria_score") %>% 
  filter(city_msa != "Portland") %>% 
  group_by(city_msa) %>% 
  filter(criteria %in% c("real_estate_score", "landlord_score", "financial_score", "climate_impact", "electricity", "climate_risk", "climate_EAL_risk", "health_impact", "electricity"))


ggplot(data = score_tidy, aes(y = city_msa, x = criteria_score, fill = criteria)) + 
    geom_col()
  
```


