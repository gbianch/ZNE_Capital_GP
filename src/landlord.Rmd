---
title: "landlord"
author: "Virginia Pan"
date: "10/21/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(googlesheets4)
library(janitor)
library(tidyverse)
library(DT)
library(readxl)
library(xlsx)
library(here)
source(here("R/normalize.R"))

MSA_landlord_data <- read_sheet("https://docs.google.com/spreadsheets/d/1zCePYRyJ5lb1Z5jvCujg17EtwqpxJN1E1_HwJL66uLM/edit#gid=122953884") %>% 
  clean_names()

```

# Normalizing Landlord Metrics

```{r}
#security_deposit_limit
landlord_metrics <- MSA_landlord_data %>% 
  mutate(
    security_deposit_limit_num = case_when(
      security_deposit_limit == "N" ~ 1.0, 
      security_deposit_limit == "1_month_rent" ~ 0.0,
      security_deposit_limit == "2_months_rent" ~ 0.5)) %>% 
    #"invert" normalized score for eviction notice days
#1 - normalized score (since more eviction notice is worse for landlords)
  mutate(n_eviction_notice = 1- normalize(eviction_notice_days),
         n_security_deposit = normalize(security_deposit_limit_num))

# output into excel
xlsx::write.xlsx2(landlord_metrics, here("data/intermediate/metric_data.xlsx"), sheetName = "landlord_metrics", append=TRUE)

# assign numeric values to security deposit limit for all states
state_landlord_policy <- state_landlord_policy %>% 
  mutate(security_deposit_limit = case_when(
      deposit_limit == "N" ~ 1.0, 
      deposit_limit == "1_months_rent" ~ 0.0,
      deposit_limit == "1_month_rent" ~ 0.0,
      deposit_limit == "1.5_months_rent" ~ 0.25,
      deposit_limit == "2_months_rent" ~ 0.5,
      deposit_limit == "2.5_months_rent" ~ 0.75,
      deposit_limit == "3_months_rent" ~ 0.75)) %>% 
   #"invert" normalized score for eviction notice days
#1 - normalized score (since more eviction notice is worse for landlords)
  mutate(n_eviction_notice = 1- normalize(eviction_days),
         n_security_deposit = normalize(security_deposit_limit))
  

```

# Calculate landlord category score

```{r}
#input landlord weights for each indicator in the following order: eviction notice days, security deposit limit, notice for entry 

#Weights must sum to 1
landlord_weights <- c(0.8, 0.2)

#make landlord_score column
wt_landlord_data <- landlord_metrics %>% 
  select(msa, cbsa, state, c(starts_with("n_"))) %>% 
  mutate(
    wt_evict_notice = n_eviction_notice*landlord_weights[1],
    wt_secur_deposit = n_security_deposit*landlord_weights[2]) %>% 
  mutate(landlord_score = apply(.[, 6:7], 1, sum)) %>% 
  select(msa, state, cbsa, 6:8) %>% 
  mutate_if(is.numeric,round, digits = 5) 


#If there is rent control, immediately disqualify location (set score to -999)
#for (j in 1:nrow(MSA_landlord_data)) {
 # if(MSA_landlord_data$rent_control[j] == "Y"){
  #  MSA_landlord_data$landlord_score[j] = -999
  #}

xlsx::write.xlsx2(wt_landlord_data, here("data/intermediate/weighted_data.xlsx"), sheetName = "wt_landlord_metrics", append=TRUE)

```

# reOpt Metric data wrangling and normalization

```{r}
# read in reopt data (for STCOFIPS codes)
reopt_metrics <- read_xlsx(here("data/intermediate/metric_data.xlsx"), sheet="reopt_metrics") %>% 
  clean_names() %>% 
  drop_na() %>% 
  rename(
  electricity_generation = annual_renewable_electricity_percent_of_total,
  total_co2 = lifecycle_total_t_co2,
  health_emissions_cost = lifecycle_costs_of_health_emissions_difference_from_bau) %>% 
  select(!system_capacity_100_for_100_apartments) %>% 
   mutate(stcofips = as.character(stcofips_5_digit))
  
# merge reopt data with climate risk data
n_reopt_metrics <- reopt_metrics %>% 
mutate(across(electricity_generation:total_co2, normalize, .names = "n_{.col}")) %>% 
  select(cbsa, city_msa, state, starts_with("n_"))

xlsx::write.xlsx2(n_reopt_metrics, here("data/intermediate/metric_data.xlsx"), sheetName = "n_reopt_metrics", append=TRUE)

```


# reOpt Metric data wrangling and normalization

```{r}
#read in National Risk Index (NRI) county data
climate_risk_metrics <- read_csv(here("data/raw/NRI_Table_Counties.csv")) %>% 
  clean_names() %>% 
  select(state, stateabbrv, county, stcofips, risk_score) %>% 
  right_join(reopt_metrics, by = join_by(stcofips==stcofips)) %>% 
  select(1:"city_msa")

# normalize climate risk score
n_climate_risk <- climate_risk_metrics %>% 
  mutate(n_climate_risk = 1- normalize(risk_score)) #invert normalized scores so that places with less climate risk have a better score

xlsx::write.xlsx2(n_climate_risk, here("data/intermediate/metric_data.xlsx"), sheetName = "n_climate_risk_metrics", append=TRUE)
```

