---
title: "Reopt"
author: "Grace Bianchi"
date: "2023-04-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(httr)
library(RJSONIO)
library(jsonlite)
```

```{r}
# Set your API key
api_key <- "GZtZAUcX97VchjrLAeeN3amg2pslaO3hbtCQgXBl"

# Set the URL for the job submission endpoint
url <- "https://developer.nrel.gov/api/reopt/stable/job"

job_url <- paste0(url, "?api_key=", api_key)
```

```{r}
# create list of default inputs for each city
inputs <- list(
  ModuleType = "Premium",
  DCACratio = 1.35,
  System_losses = 5,
  FederalIncentive = 30
)
```

```{r}

# Set the payload for the job submission request
payload <- list(
  "Scenario" = list(
    "Site" = list(
      "longitude" = -118.1164613,
      "latitude" = 34.5794343,
      "roof_squarefeet" = 5000.0,
      "land_acres" = 1.0,
      "PV" = list(
        "installed_cost_us_dollars_per_kw" = 2000.0,
        "tilt" = 34.579,
        "degradation_pct" = 0.005,
        "macrs_option_years" = 5,
        "federal_itc_pct" = 0.3,
        "module_type" = 0,
        "array_type" = 1,
        "om_cost_us_dollars_per_kw" = 16.0,
        "macrs_itc_reduction" = 0.5,
        "azimuth" = 180.0,
        "federal_rebate_us_dollars_per_kw" = 350.0
      ),
      "LoadProfile" = list(
        "doe_reference_name" = "MidriseApartment",
        "annual_kwh" = 10000000.0,
        "city" = "LosAngeles"
      ),
      "Storage" = list(
        "total_rebate_per_kw" = 100.0,
        "macrs_option_years" = 5,
        "can_grid_charge" = TRUE,
        "macrs_bonus_pct" = 0.4,
        "macrs_itc_reduction" = 0.5,
        "total_itc_pct" = 0,
        "installed_cost_us_dollars_per_kw" = 1000.0,
        "installed_cost_us_dollars_per_kwh" = 500.0,
        "replace_cost_us_dollars_per_kw" = 460.0,
        "replace_cost_us_dollars_per_kwh" = 230.0
      ),
      "ElectricTariff" = list(
        "urdb_label" = "5ed6c1a15457a3367add15ae"
      ),
      "Financial" = list(
        "escalation_pct" = 0.026,
        "offtaker_discount_pct" = 0.081,
        "owner_discount_pct" = 0.081,
        "analysis_years" = 20,
        "offtaker_tax_pct" = 0.4,
        "owner_tax_pct" = 0.4,
        "om_cost_escalation_pct" = 0.025
      )
    )
  )
)


```

```{r}
# Make the request to submit the job
response <- POST(url, query = list(api_key = api_key), body = payload, encode = "json", timeout(30))

# Check the response status code
status_code <- response$status_code
if (status_code == 200) {
  message("Inputs updated successfully.")
} else {
  message("Error updating inputs.")
}

# get run_uuid to obtain outputs
output <- httr::content(response)
run_uuid <- output$run_uuid
```

 
```{r}
results_url <- paste0("https://developer.nrel.gov/api/reopt/stable/job/", run_uuid, "/results")

# Send the GET request to retrieve the results
response <- GET(url = results_url, query = list(api_key = api_key), timeout(30))

# Extract the response content as JSON and convert it to a list
response_content <- content(response, as="text")
response_json <- fromJSON(response_content)

# pull out IMPORTANT data
output_df <- data.frame(
  IRR = response_json$outputs$Scenario$Site$Financial$irr_pct,
  Health_Emissions_Cost = response_json$outputs$Scenario$Site$lifecycle_emissions_cost_Health_bau,
  Annual_Generation_Renewables = response_json$outputs$Scenario$Site$annual_renewable_electricity_pct)

```
 
```{r}
host <- "https://developer.nrel.gov/api/reopt"
api_key <- "?API_KEY=GZtZAUcX97VchjrLAeeN3amg2pslaO3hbtCQgXBl"
version_url <- file.path(host, help_end, api)
api_version <- jsonlite::fromJSON(version_url) # retrieved 

```


```{r}

## energy goals
#cost_savings and clean_energy
## inputs not default 
host_eff <- 0
scc = 185 

#PV & wind space available:  ❌ Land only ✅ Roofspace only ❌ Land & roofspace

#PV System Characteristics
ModuleType= Premium
DCACratio = 1.35
System_losses = 5
FederalIncentive= 30

```


```{r}
# test scenario post
test <- "https://reopt.nrel.gov/tool/results/f4e6c9db-3c22-43a4-b2bf-15146aec9896"

```

