---
title: "Reopt"
author: "Grace Bianchi"
date: "2023-04-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(httr)
library(RJSONIO)
library(jsonlite)
```

```{r}
# Set your API key
api_key <- "GZtZAUcX97VchjrLAeeN3amg2pslaO3hbtCQgXBl"

# Set the URL for the job submission endpoint
url <- "https://developer.nrel.gov/api/reopt/stable/job"

job_url <- paste0(url, "?api_key=", api_key)
```

```{r}
# create list of default inputs for each city
inputs <- list(
  offtaker_tax_pct = 0, # host effective tax rate
  co2_cost_us_dollars_per_tonne = 185,
  module_type = 1,
  dc_ac_ratio = 1.35,
  losses = 0.05,
  federal_itc_pct = 0.3,
  location = "roof", # restrict projects to roof
  can_net_meter = TRUE
  
)
```

```{r}
# Set the payload for the job submission request
payload <- list(
  "Scenario" = list(
    "Site" = list(
      "longitude" = -118.1164613,
      "latitude" = 34.5794343,
      "roof_squarefeet" = 5000.0,
      "land_acres" = 1.0,
      "PV" = list(
        "installed_cost_us_dollars_per_kw" = 2000.0,
        "federal_rebate_us_dollars_per_kw" = 350.0,
        # changes from default
        "module_type" = 1,
        "dc_ac_ratio" = 1.35,
        "losses" = 0.05,
        "federal_itc_pct" = 0.3,
        "location" = "roof", # restrict projects to roof
        "can_net_meter" = TRUE
      ),
      "LoadProfile" = list(
        "doe_reference_name" = "MidriseApartment",
        "annual_kwh" = 10000000.0,
        "city" = "LosAngeles"
      ),
      "ElectricTariff" = list(
        "urdb_label" = "5ed6c1a15457a3367add15ae",
        "add_tou_energy_rates_to_urdb_rate" = TRUE
      ),
      "Financial" = list(
        "escalation_pct" = 0.026,
        "offtaker_discount_pct" = 0.081,
        "owner_discount_pct" = 0.081,
        "analysis_years" = 20,
        "offtaker_tax_pct" = 0.4,
        "owner_tax_pct" = 0.4,
        "om_cost_escalation_pct" = 0.025
      )
    )
  )
)


```


```{r}
```


```{r}

## open EI api
## open EI api
openEI_api_key <- "rU6MEqhK9OJ7obAnmcbzYhpFOenfBM5Q8GF0yJFA"

openEI_start <- "https://api.openei.org/utility_rates?version=latest&format=json&sector=Residential&detail=full&approved=true&"
# Set the URL for the job submission endpoint

openEI_url <- paste0(openEI_start, "address=", zipcodes, "&api_key=", openEI_api_key)
EIresponse <- GET(openEI_url)
content <- content(EIresponse, "text")
json <- fromJSON(content)

 # extract utility rate information
EIutility_df <- list(
  label = json$items$label,
  utility = json$items$utility,
  rate_name = json$items$name)
```

```{r}

openEI_start_url <- "https://api.openei.org/utility_rates?version=latest&format=json&sector=Residential&detail=full&approved=true&address="
openEI_api_end <- "&api_key=rU6MEqhK9OJ7obAnmcbzYhpFOenfBM5Q8GF0yJFA"

### Function w for loop
get_utility_data <- function(zipcodes) {
  # Create an empty list to store the resulting data frames
  utility_info <- list()
  # get data for each zipcode in vector
  for (zipcode in zipcodes) {
    openEI_start_url <- "https://api.openei.org/utility_rates?version=latest&format=json&sector=Residential&detail=full&approved=true&address="
    openEI_api_end <- "&api_key=rU6MEqhK9OJ7obAnmcbzYhpFOenfBM5Q8GF0yJFA"
    
    openEI_url <- paste0(openEI_start_url, zipcode, openEI_api_end)
    response <- GET(openEI_url)
    # extract content and parse as JSON
    content <- content(response, "text")
    json <- fromJSON(content)
    
    # create a data frame with the extracted utility info
    utility_df <- data.frame(
      "zipcode" = rep(zipcode, each = nrow(json$items$label)),
      "label" = json$items$label,
      "utility" = json$items$utility,
      "rate_name" = json$items$name
    )
    
    # append the resulting data frame to the list
    utility_info[[length(utility_info) + 1]] <- utility_df
  }
  
  # combine the resulting data frames into a single data frame
  combined_utility_info <- do.call(rbind, utility_info)
  
  return(combined_utility_info)
}

utility_info_zips <- get_utility_data(zipcodes = zipcodes)

```

```{r}
zipcodes <- c("46033", "93105", "90404")
## functiion wiith out for loop
get_zip_utility <- function(zipcode){
  openEI_start_url <- "https://api.openei.org/utility_rates?version=latest&format=json&sector=Residential&detail=full&approved=true&address="
openEI_api_end <- "&api_key=rU6MEqhK9OJ7obAnmcbzYhpFOenfBM5Q8GF0yJFA"
zipcode=zipcode

  openEI_url <- paste0(openEI_start_url, zipcode, openEI_api_end)
  response <- GET(openEI_url)
  # extract content and parse as JSON
  content <- content(EIresponse, "text")
  json <- fromJSON(content)
  
  utility_df <- data.frame(
  # repeat zipcode in each row for each utility observation
  "zipcode" = rep(zipcode, each=nrow(json$items$label)),
  "label" = json$items$label,
    "utility" = json$items$utility,
    "rate_name" = json$items$name)

}

test <- get_zip_utility("46033")
utility_info <- pmap(list(zipcode=zipcodes), get_zip_utility)

utilitu_info = as.data.frame(utility_info)
```



```{r STUFF TO WORK ON}

net_metering_limit_kw # by state

```

```{r}
# Make the request to submit the job
response <- POST(url, query = list(api_key = api_key), body = payload, encode = "json", timeout(30))

# Check the response status code
status_code <- response$status_code
if (status_code == 200) {
  message("Inputs updated successfully.")
} else {
  message("Error updating inputs.")
}

# get run_uuid to obtain outputs
output <- httr::content(response)
run_uuid <- output$run_uuid
```

 
```{r}
## GET RESULTS FROM REOPT
results_url <- paste0("https://developer.nrel.gov/api/reopt/stable/job/", run_uuid, "/results")

# Send the GET request to retrieve the results
response <- GET(url = results_url, query = list(api_key = api_key), timeout(30))

# Extract the response content as JSON and convert it to a list
response_content <- content(response, as="text")
response_json <- fromJSON(response_content)

# pull out IMPORTANT data
output_df <- data.frame(
  IRR = response_json$outputs$Scenario$Site$Financial$irr_pct,
  Health_Emissions_Cost = response_json$outputs$Scenario$Site$lifecycle_emissions_cost_Health_bau,
  Annual_Generation_Renewables = response_json$outputs$Scenario$Site$annual_renewable_electricity_pct)

```
 
```{r}
host <- "https://developer.nrel.gov/api/reopt"
api_key <- "?API_KEY=GZtZAUcX97VchjrLAeeN3amg2pslaO3hbtCQgXBl"
version_url <- file.path(host, help_end, api)
api_version <- jsonlite::fromJSON(version_url) # retrieved 

```


```{r}



#PV & wind space available:  ❌ Land only ✅ Roofspace only ❌ Land & roofspace

#PV System Characteristics
ModuleType= Premium
DCACratio = 1.35
System_losses = 5
FederalIncentive= 30

```


```{r}
# test scenario post
test <- "https://reopt.nrel.gov/tool/results/f4e6c9db-3c22-43a4-b2bf-15146aec9896"

```

