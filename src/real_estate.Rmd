---
title: "Real Estate"
author: "Grace Bianchi"
date: '2022-10-21'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(janitor) # clean_names()
library(googlesheets4)
library(DT)
library(openxlsx)
library(here)
source(here("R/normalize.R"))

city_occupancy_data <- read_sheet("https://docs.google.com/spreadsheets/d/10n55Gt0rySN96OGTQ2_8PzeTcX66n26sOlZBiuiAeBU/edit#gid=808954990") %>% 
  clean_names() %>% 
  rename(occ_rate2021 = percent_occupancy_2021)

MSA_dempgraphic_data <- read_sheet("https://docs.google.com/spreadsheets/d/1lmTpSDwVANxdAg5sW87Q8l_gtig7M0EjPPJ6J5_7dwg/edit?usp=sharing", sheet = "MSA_demographics") %>% 
  clean_names() %>% 
  
  inner_join(city_occupancy_data, by = join_by(cbsa== cbsa, anchor_city==city)) 


```

```{r}
# calculate metrics
real_estate_metrics<- MSA_dempgraphic_data %>% 
    # calculate rent change
  mutate(cbsa = factor(cbsa),
         rent_change = (med_rent2022 - med_rent2021)/med_rent2021 * 100,
         house_price_2021 = as.numeric(house_price_2021),
         income_to_homeprice = med_income/house_price_2021,
         rent_to_income = (med_rent2021*12)/med_income) %>%  # multiply monthly rent x 12 for annual rent!
  select(!c(state.y, popestimate2021, med_rent2021, med_rent2022, house_price_2021, med_income)) %>% 
  rename(pop_change = pop_percent_change20_21)

write.xlsx(real_estate_metrics, here("data/intermediate/metric_data.xlsx"), sheetName = "real_estate_metrics")

#sheet_write(compliedMSA_realEstate, ss = "https://docs.google.com/spreadsheets/d/1lmTpSDwVANxdAg5sW87Q8l_gtig7M0EjPPJ6J5_7dwg/edit#gid=426650684", sheet = "real_estate_metrics")

```

# Normalize Metrics

```{r}
n_real_estate_metrics <- real_estate_metrics %>%
  # normalize cols and rename columns to start with n
  mutate(across(5:10, normalize, .names = "n_{.col}")) %>% 
  mutate(n_income_to_homeprice = 1- n_income_to_homeprice, # subtracted from 1 so higher values are more favorable
         n_rent_to_income = 1 - n_rent_to_income) %>% 
  select(cbsa, msa, anchor_city, state.x, starts_with("n_"))

write.xlsx(n_real_estate_metrics, here("data/intermediate/normalized_data.xlsx"), sheetName = "real_estate_metrics")
```

```{r}
real_estate_weights <- c(0.35, # pop change weight
                         0.20, # employment change weight
                         0.15, # occupancy weight
                         0.10, # rent change weight
                         0.10, # rent to income weight
                         0.10) # income to homeprice weight


wt_real_estate_metrics <- n_real_estate_metrics %>% 
  mutate(wt_pop_change = n_pop_change* real_estate_weights[1],
         wt_employ_change = n_employ_change* real_estate_weights[2],
         wt_occ = n_occ_rate2021* real_estate_weights[3],
         wt_rent_change = n_rent_change* real_estate_weights[4],
         wt_rent_income = n_rent_to_income* real_estate_weights[5],
         wt_income_homeprice = n_income_to_homeprice* real_estate_weights[6]) %>% 
  select(!starts_with("n_")) %>% 
  mutate(real_estate_score = apply(.[, 5:10], 1, sum)) %>% 
  mutate_if(is.numeric,round, digits = 4) 

write.xlsx(wt_real_estate_metrics, here("data/intermediate/weighted_criteria_data.xlsx"), sheetName = "wt_real_estate_metrics")
```



```{r}
#write result to google sheet
#gs4_create("anchor_real_estate_score")
#sheet_write(n_MSA_realEstate, ss = "https://docs.google.com/spreadsheets/d/1Ssmb7pUd4NFZocVp9C75SRMOV6tAJCCt0TjrCYBB8pY/edit?usp=sharing", sheet = "anchor_realEstate")
```



